version: "3.9"  

services:  
  alloy:  
    image: grafana/alloy:latest  
    container_name: alloy  
    user: root  
    privileged: true  
    volumes:  
      - ./config.alloy:/etc/alloy/config.alloy  
      - /var/run/docker.sock:/var/run/docker.sock   
    command:  
      - run  
      - --server.http.listen-addr=0.0.0.0:12345  
      - /etc/alloy/config.alloy  
    ports:  
      - "12345:12345"  
      - "4317:4317"  
      
    environment:  
      - LOG_LEVEL=debug  
      - GRAFANA_CLOUD_TEMPO_USER=  
      - GRAFANA_CLOUD_TEMPO_API_KEY=
      - GRAFANA_CLOUD_LOKI_USER=  
      - GRAFANA_CLOUD_LOKI_API_KEY=
      - GRAFANA_CLOUD_PROMETHEUS_USER=
      - GRAFANA_CLOUD_PROMETHEUS_API_KEY=

  app:  
    build: .  
    container_name: foodme  
    depends_on:  
      - alloy  
    environment:  
      # ✅ Traces (keep as-is - working via Alloy)  
      - OTEL_SERVICE_NAME=foodme-api
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://alloy:4317  
      - OTEL_TRACES_EXPORTER=otlp  
      
      # ✅ Loki (for direct pino-loki push from app)  
      - GRAFANA_LOKI_USER=  
      - GRAFANA_LOKI_API_KEY=  
      
      # Optional but recommended  
      - LOG_LEVEL=info  
      - NODE_ENV=production  
      - SERVICE_VERSION=1.0.0  
    ports:  
      - "3000:3000"  